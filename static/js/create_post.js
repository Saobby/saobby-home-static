"use strict";var domain="https://comments.saobby.com",last_save_draft=0;function preview(e){e&&(gebi("preview-html").innerHTML=marked.parse(gebi("content-input").value)),gebi("content-input").hidden=e,gebi("preview-html").hidden=!e,gebi("preview-btn").hidden=e,gebi("edit-btn").hidden=!e}function release(){var e=gebi("title-input").value,t=gebi("content-input").value;if(""===e||""===t)return gebi("result").innerHTML="标题和正文均不能为空",null;gebi("content-input").disabled=!0,gebi("title-input").disabled=!0,set_btn_html(gebi("release-btn"),"..."),saobbyCaptchaV2.open_window_and_return_promise().then((function(n){set_btn_html(gebi("release-btn"),"稍等");var i={access_token:localStorage.getItem("access-token"),title:e,content:t,captcha_token:gebi("scpc-token").value};fetch_data(domain+"/api/create_post","POST",headers,JSON.stringify(i)).then((function(e){var t=JSON.parse(e.response_text);t.success?(gebi("result").innerHTML="发表成功",window.location="/post/?pid="+t.data.name):gebi("result").innerHTML=t.message,gebi("content-input").disabled=!1,gebi("title-input").disabled=!1,set_btn_html(gebi("release-btn"))}),(function(e){gebi("result").innerHTML=e.message,gebi("content-input").disabled=!1,gebi("title-input").disabled=!1,set_btn_html(gebi("release-btn"))}))}),(function(e){gebi("result").innerHTML="请先完成人机验证:"+e.message,gebi("content-input").disabled=!1,gebi("title-input").disabled=!1,set_btn_html(gebi("release-btn"))}))}function load_post_draft(){function e(e){gebi("result").innerHTML=e}var t=localStorage.getItem("access-token");if(t){var n={access_token:t};fetch_data(domain+"/api/get_post_draft","POST",headers,JSON.stringify(n)).then((function(t){var n=JSON.parse(t.response_text);n.success?function(e){if(e){var t=JSON.parse(e),n=t.t,i=t.c;i&&(gebi("content-input").value=i),n&&(gebi("title-input").value=n)}}(n.data.content):e("无法加载草稿:"+n.message)}),(function(t){e("无法加载草稿:"+t.message)}))}}function save_post_draft(){function e(e){gebi("result").innerHTML=e}var t=(new Date).getTime()/1e3;if(!(t-last_save_draft<1)){last_save_draft=t;var n=localStorage.getItem("access-token");if(n){var i=gebi("content-input").value,a=gebi("title-input").value;if(i||a){var s={content:JSON.stringify({t:a,c:i}),access_token:n};fetch_data(domain+"/api/save_post_draft","POST",headers,JSON.stringify(s)).then((function(t){var n=JSON.parse(t.response_text);n.success||e("无法保存草稿:"+n.message)}),(function(t){e("无法保存草稿:"+t.message)}))}}}}null===localStorage.getItem("access-token")&&(localStorage.login_redirect=window.location.href,window.location="/login"),load_post_draft();