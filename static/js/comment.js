function is_in_array(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}var nurl=window.location.href.split("?");if(1==nurl.length)void 0===localStorage.comment_place_id&&(localStorage.comment_place_id=114514);else{var args=nurl[1].split("&");localStorage.comment_place_id=args[0],is_in_array(args,"no-redirect")||(window.location.href="/"),is_in_array(args,"comments-only")&&(document.getElementById("contact").hidden=!0,document.getElementById("tools").hidden=!0)}function show_comment_window(){if(null==localStorage["access-token"])return localStorage.login_redirect=window.location.href,void(window.location="/login");document.getElementById("comment-window").hidden=!1}function add_root_comment(){var e=document.getElementById("content").value;""!=e?(get_captcha_img(),document.getElementById("captcha-window").hidden=!1,args={place_id:place_id,access_token:localStorage["access-token"],content:e,reply_to:-1}):document.getElementById("result0").innerHTML="评论不能为空!"}function complete_captcha(){-1==args.reply_to?(document.getElementById("rel-btn").disabled=!0,document.getElementById("rel-btn").innerHTML="请稍候"):(document.getElementById(`rel-btn-${args.reply_to}`).disabled=!0,document.getElementById(`rel-btn-${args.reply_to}`).innerHTML="请稍候");var e=new XMLHttpRequest;e.open("POST","https://fast-comment.saobby.com/api/post_comment",!0),e.setRequestHeader("Content-Type","application/json"),args.captcha_token=document.getElementById("captcha-token").value,e.send(JSON.stringify(args)),e.onreadystatechange=function(){if(4==e.readyState){var t=JSON.parse(e.responseText);t.success?(-1==args.reply_to?(document.getElementById("result0").innerHTML="评论发送成功!",document.getElementById("content").value="",comment_page_index=0,get_all_comment()):(document.getElementById(`reply-result-${args.reply_to}`).innerHTML="评论发送成功!",document.getElementById(`reply-content-${args.reply_to}`).value=""),get_all_comment()):-1==args.reply_to?document.getElementById("result0").innerHTML=t.message:document.getElementById(`reply-result-${args.reply_to}`).innerHTML=t.message,-1==args.reply_to?(document.getElementById("rel-btn").disabled=!1,document.getElementById("rel-btn").innerHTML="发表"):(document.getElementById(`rel-btn-${args.reply_to}`).disabled=!1,document.getElementById(`rel-btn-${args.reply_to}`).innerHTML="发表")}}}function get_all_comment(){var e=new XMLHttpRequest;e.open("POST","https://fast-comment.saobby.com/api/get_comment",!0),e.setRequestHeader("Content-Type","application/json");var t={place_id:place_id,amount_per_page:8,page_index:comment_page_index};e.send(JSON.stringify(t)),e.onreadystatechange=function(){if(4==e.readyState){var t=JSON.parse(e.responseText);if(t.success){var n="";for(var o in t.data)n+=read_comment(t.data[o],0);document.getElementById("comment-area").innerHTML=n,t.data.length<8?document.getElementById("next-page").disabled=!0:document.getElementById("next-page").disabled=!1,0==comment_page_index?document.getElementById("prev-page").disabled=!0:document.getElementById("prev-page").disabled=!1}else document.getElementById("comment-area").innerHTML="无法获取到评论,因为:"+t.message}}}function read_comment(e,t){var n="",o=e.content,a=marked.parse(o),l=e.username.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"),d=e.reply_to;for(var r in n+=`<div style="position:relative;left:${40*t}px;" id="comment-area-${e.cid}"><div style="border-bottom: 2px solid #ddd;padding:12px 16px;"><img src="${e.avatar_url}" width="32px" height="32px"><b style="position:relative;top:-17px;left:5px;">${l}</b><span style="color:#777777;position:relative;top:-17px;left:5px;"> 发表于 ${ts2str(e.timestamp)} #${e.cid}</span><br>`,-1!=d&&(n+=`<span style="color:#777777">回复 #${e.reply_to}</span><br>`),n+=`<div>${a}</div><button onclick="show_reply_window(${e.cid})" class="wux-btn wux-btn-primary wux-btn-sm" id="reply-btn-${e.cid}">回复</button></div></div>`,e.replies)n+=read_comment(e.replies[r],t+1);return n}function ts2str(e){var t=new Date(1e3*e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)}function show_reply_window(e){if(null==localStorage["access-token"])return localStorage.login_redirect=window.location.href,void(window.location="/login");document.getElementById(`reply-btn-${e}`).disabled=!0;var t=document.getElementById(`comment-area-${e}`);if(null==document.getElementById(`comment-window-${e}`)){var n=`<div id="comment-window-${e}">\n            <textarea class="wux-form-input wux-form-input-md" placeholder="回复 #${e} (支持Markdown语法)" rows="5" id="reply-content-${e}"></textarea>\n            <button class="wux-btn wux-btn-primary wux-btn-outline" onclick="document.getElementById('comment-window-${e}').hidden=true;document.getElementById('reply-btn-${e}').disabled=false;" type="button">取消</button><button class="wux-btn wux-btn-primary" type="button" onclick="add_reply_comment(${e},document.getElementById('reply-content-${e}').value)" id="rel-btn-${e}">发表</button>\n            <span id="reply-result-${e}" style="color:#aa0000"></span>\n        </div>`;t.innerHTML=t.innerHTML+n}else document.getElementById(`comment-window-${e}`).hidden=!1}function add_reply_comment(e,t){""!=t?(get_captcha_img(),document.getElementById("captcha-window").hidden=!1,args={place_id:place_id,access_token:localStorage["access-token"],content:t,reply_to:e}):document.getElementById(`reply-result-${e}`).innerHTML="评论不能为空!"}function change_page(e){document.getElementById("next-page").disabled=!0,document.getElementById("prev-page").disabled=!0,comment_page_index+=e,get_all_comment()}place_id=localStorage.comment_place_id,comment_page_index=0,marked.setOptions({tables:!0,sanitize:!0,smartLists:!0,silent:!0}),get_all_comment();
