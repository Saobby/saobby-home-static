"use strict";function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function(){return e};var t,e={},n=Object.prototype,i=n.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},c="function"==typeof Symbol?Symbol:{},a=c.iterator||"@@iterator",r=c.asyncIterator||"@@asyncIterator",d=c.toStringTag||"@@toStringTag";function s(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(t){s=function(t,e,n){return t[e]=n}}function l(t,e,n,i){var c=e&&e.prototype instanceof f?e:f,a=Object.create(c.prototype),r=new E(i||[]);return o(a,"_invoke",{value:S(t,n,r)}),a}function u(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var b="suspendedStart",p="suspendedYield",m="executing",g="completed",h={};function f(){}function _(){}function y(){}var w={};s(w,a,(function(){return this}));var v=Object.getPrototypeOf,x=v&&v(v(N([])));x&&x!==n&&i.call(x,a)&&(w=x);var k=y.prototype=f.prototype=Object.create(w);function L(t){["next","throw","return"].forEach((function(e){s(t,e,(function(t){return this._invoke(e,t)}))}))}function T(t,e){function n(o,c,a,r){var d=u(t[o],t,c);if("throw"!==d.type){var s=d.arg,l=s.value;return l&&"object"==_typeof(l)&&i.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,r)}),(function(t){n("throw",t,a,r)})):e.resolve(l).then((function(t){s.value=t,a(s)}),(function(t){return n("throw",t,a,r)}))}r(d.arg)}var c;o(this,"_invoke",{value:function(t,i){function o(){return new e((function(e,o){n(t,i,e,o)}))}return c=c?c.then(o,o):o()}})}function S(e,n,i){var o=b;return function(c,a){if(o===m)throw Error("Generator is already running");if(o===g){if("throw"===c)throw a;return{value:t,done:!0}}for(i.method=c,i.arg=a;;){var r=i.delegate;if(r){var d=M(r,i);if(d){if(d===h)continue;return d}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(o===b)throw o=g,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);o=m;var s=u(e,n,i);if("normal"===s.type){if(o=i.done?g:p,s.arg===h)continue;return{value:s.arg,done:i.done}}"throw"===s.type&&(o=g,i.method="throw",i.arg=s.arg)}}}function M(e,n){var i=n.method,o=e.iterator[i];if(o===t)return n.delegate=null,"throw"===i&&e.iterator.return&&(n.method="return",n.arg=t,M(e,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),h;var c=u(o,e.iterator,n.arg);if("throw"===c.type)return n.method="throw",n.arg=c.arg,n.delegate=null,h;var a=c.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,h):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,h)}function H(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function O(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function E(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(H,this),this.reset(!0)}function N(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,c=function n(){for(;++o<e.length;)if(i.call(e,o))return n.value=e[o],n.done=!1,n;return n.value=t,n.done=!0,n};return c.next=c}}throw new TypeError(_typeof(e)+" is not iterable")}return _.prototype=y,o(k,"constructor",{value:y,configurable:!0}),o(y,"constructor",{value:_,configurable:!0}),_.displayName=s(y,d,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===_||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,y):(t.__proto__=y,s(t,d,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},L(T.prototype),s(T.prototype,r,(function(){return this})),e.AsyncIterator=T,e.async=function(t,n,i,o,c){void 0===c&&(c=Promise);var a=new T(l(t,n,i,o),c);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},L(k),s(k,d,"Generator"),s(k,a,(function(){return this})),s(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var i in e)n.push(i);return n.reverse(),function t(){for(;n.length;){var i=n.pop();if(i in e)return t.value=i,t.done=!1,t}return t.done=!0,t}},e.values=N,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(O),!e)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function o(i,o){return r.type="throw",r.arg=e,n.next=i,o&&(n.method="next",n.arg=t),!!o}for(var c=this.tryEntries.length-1;c>=0;--c){var a=this.tryEntries[c],r=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var d=i.call(a,"catchLoc"),s=i.call(a,"finallyLoc");if(d&&s){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(d){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!s)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&i.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var c=o;break}}c&&("break"===t||"continue"===t)&&c.tryLoc<=e&&e<=c.finallyLoc&&(c=null);var a=c?c.completion:{};return a.type=t,a.arg=e,c?(this.method="next",this.next=c.finallyLoc,h):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),h},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),O(n),h}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var i=n.completion;if("throw"===i.type){var o=i.arg;O(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,n,i){return this.delegate={iterator:N(e),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=t),h}},e}function asyncGeneratorStep(t,e,n,i,o,c,a){try{var r=t[c](a),d=r.value}catch(t){return void n(t)}r.done?e(d):Promise.resolve(d).then(i,o)}function _asyncToGenerator(t){return function(){var e=this,n=arguments;return new Promise((function(i,o){var c=t.apply(e,n);function a(t){asyncGeneratorStep(c,i,o,a,r,"next",t)}function r(t){asyncGeneratorStep(c,i,o,a,r,"throw",t)}a(void 0)}))}}var domain="https://comments.saobby.com",last_save_draft=0;function get_element_abs_pos2(t){for(var e=t.offsetTop,n=t.offsetLeft;t=t.offsetParent;)e+=t.offsetTop,n+=t.offsetLeft;return{left:n,top:e}}function show_comment_window(){localStorage["access-token"]?(gebi("comment-window").hidden=!1,load_comment_draft(-1)):(localStorage.login_redirect=window.location.href,window.location="/login")}function add_comment(t,e){""!=e?(-1==t?(set_btn_html(gebi("rel-btn"),"请完成验证码"),gebi("cancel-btn").disabled=!0,gebi("content-preview-btn").disabled=!0,gebi("content-edit-btn").disabled=!0):(set_btn_html(gebi("rel-btn-"+t),"请完成验证码"),gebi("content-".concat(t,"-preview-btn")).disabled=!0,gebi("content-".concat(t,"-edit-btn")).disabled=!0,gebi("cancel-rp-"+t).disabled=!0),saobbyCaptchaV2.open_window_and_return_promise().then((function(n){-1==t?set_btn_html(gebi("rel-btn"),"请稍候"):set_btn_html(gebi("rel-btn-"+t),"请稍候"),fetch_data(domain+"/api/post_comment","POST",headers,JSON.stringify({place_id:place_id,access_token:localStorage["access-token"],content:e,reply_to:t,captcha_token:gebi("scpc-token").value})).then((function(e){var n=JSON.parse(e.response_text);n.success?(-1==t?(gebi("result0").innerHTML="评论发送成功!",gebi("content").value="",gebi("content-preview").innerHTML="",comment_page_index=0):(gebi("reply-result-"+t).innerHTML="评论发送成功!",gebi("reply-content-"+t).value="",gebi("content-preview-"+t).innerHTML=""),get_all_comment()):-1==t?gebi("result0").innerHTML=n.message:gebi("reply-result-"+t).innerHTML=n.message,-1==t?(gebi("cancel-btn").disabled=!1,gebi("content-preview-btn").disabled=!1,gebi("content-edit-btn").disabled=!1,set_btn_html(gebi("rel-btn"))):(gebi("content-".concat(t,"-preview-btn")).disabled=!1,gebi("content-".concat(t,"-edit-btn")).disabled=!1,gebi("cancel-rp-"+t).disabled=!1,set_btn_html(gebi("rel-btn-"+t)))}),(function(e){-1==t?(gebi("result0").innerHTML=e.message,gebi("cancel-btn").disabled=!1,gebi("content-preview-btn").disabled=!1,gebi("content-edit-btn").disabled=!1,set_btn_html(gebi("rel-btn"))):(gebi("reply-result-"+t).innerHTML=e.message,gebi("content-".concat(t,"-preview-btn")).disabled=!1,gebi("content-".concat(t,"-edit-btn")).disabled=!1,gebi("cancel-rp-"+t).disabled=!1,set_btn_html(gebi("rel-btn-"+t)))}))}),(function(e){-1==t?(gebi("result0").innerHTML="请先完成验证码:"+e.message,gebi("cancel-btn").disabled=!1,gebi("content-preview-btn").disabled=!1,gebi("content-edit-btn").disabled=!1,set_btn_html(gebi("rel-btn"))):(gebi("reply-result-"+t).innerHTML="请先完成验证码:"+e.message,gebi("content-".concat(t,"-preview-btn")).disabled=!1,gebi("content-".concat(t,"-edit-btn")).disabled=!1,gebi("cancel-rp-"+t).disabled=!1,set_btn_html(gebi("rel-btn-"+t)))}))):-1==t?gebi("result0").innerHTML="评论不能为空":gebi("reply-result-"+t).innerHTML="评论不能为空"}function get_all_comment(){var t=new XMLHttpRequest,e=(t.open("POST",domain+"/api/get_comment",!0),t.setRequestHeader("Content-Type","application/json"),{place_id:place_id,amount_per_page:8,page_index:comment_page_index,access_token:localStorage["access-token"],scroll_to:scroll_to});t.send(JSON.stringify(e)),t.onreadystatechange=function(){if(4==t.readyState){var e=JSON.parse(t.responseText);if(e.success){var n,i="";for(n in e.data)i+=read_comment(e.data[n],0);comment_page_index=e.comment_data.page_index-1,gebi("comment-area").innerHTML=i,gebi("page_index").innerHTML=e.comment_data.page_index,gebi("page_amount").innerHTML=e.comment_data.page_amount,scroll_to&&window.scrollTo(get_element_abs_pos2(gebi("comment-area-"+scroll_to))),scroll_to=scroll_to&&void 0;var o=e.comment_data.page_index-2,c=e.comment_data.page_index+2,a=(e.comment_data.page_index-2<1&&(o=1),e.comment_data.page_index+2>e.comment_data.page_amount&&(c=e.comment_data.page_amount),"");1!=o&&(a+='<button class="wux-btn cp-btn wux-btn-outline" onclick="change_page(0);">«</button>');for(var r=o;r<=c;r++)a+='<button class="'.concat(r==e.comment_data.page_index?"wux-btn cp-btn":"wux-btn cp-btn wux-btn-outline",'" onclick="change_page(').concat(r-1,');">').concat(r,"</button>");c!=e.comment_data.page_amount&&(a+='<button class="wux-btn cp-btn wux-btn-outline" onclick="change_page('.concat(e.comment_data.page_amount-1,');">»</button>')),gebi("change-page-btn").innerHTML=a,pasteToUpload.init(),add_markdown_tips()}else gebi("comment-area").innerHTML="无法获取到评论,因为:"+e.message}}}function read_comment(t,e){var n,i="",o=t.content,c=marked.parse(o),a=rsc(t.username),r=t.reply_to;o=rsc(o);for(n in i+='<div style="position:relative;left:'.concat(20*e,'px;" id="comment-area-').concat(t.cid,'"><div style="border-bottom: 2px solid #ddd;padding:12px 16px;"><img src="').concat(t.avatar_url,'" alt="用户头像" width="32px" height="32px"><b style="position:relative;top:-17px;left:5px;">').concat(t.nickname?rsc(t.nickname):a,'</b><span style="color:#777777;position:relative;top:-17px;left:5px;" class="middle"> <img src="/static/image/icon/mail-check-grey.svg" width="16px" alt="(已绑定电子邮箱)" title="此用户已绑定电子邮箱" class="middle" ').concat(t.is_email_checked?"":"hidden",'> <img src="/static/image/icon/pencil-check-grey.svg" width="16px" alt="(已编辑)" title="(已编辑)" class="middle" ').concat(t.modify_time?"":"hidden",'> <img src="/static/image/icon/clock-grey.svg" width="16px" alt="发表时间" class="middle">').concat(t.modify_time?ts2str(t.modify_time):ts2str(t.timestamp)," #").concat(t.cid,"</span><br>"),-1!=r&&(i+='<span style="color:#777777" onclick="window.scrollTo(get_element_abs_pos2(gebi(\'comment-area-'.concat(t.reply_to,'\')))" class="middle">').concat(icon_with_text("corner-down-right-grey","回复 #"+t.reply_to.toString()),"</span><br>")),i+='<div id="comment-md-'.concat(t.cid,'" class="pre-like-code" hidden>').concat(o,'</div><div hidden><textarea id="origin-content-').concat(t.cid,'">').concat(o,'</textarea></div><div id="edit-div-').concat(t.cid,'" hidden><textarea class="wux-form-input wux-form-input-md marked-textarea" placeholder="编辑 #').concat(t.cid,' 最多1024字" rows="5" id="edit-content-').concat(t.cid,'">').concat(o,'</textarea></div><div id="edit-preview-').concat(t.cid,'" class="pre-like" hidden></div><div class="comment-content" id="comment-html-').concat(t.cid,'">').concat(c,'</div><i style="color:#777777;" ').concat(null===t.is_read?"hidden":"",">").concat(null!==t.is_read?t.is_read?"已读("+ts2str(t.read_time)+")":"未读":"","</i><br ").concat(null===t.is_read?"hidden":"",'><button onclick="show_reply_window(').concat(t.cid,')" class="wux-btn wux-btn-primary wux-btn-sm" id="reply-btn-').concat(t.cid,'">').concat(icon_with_text("message-reply-white","回复"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline" id="view-md-').concat(t.cid,'" onclick="gebi(\'comment-md-').concat(t.cid,"').hidden=!1;gebi('comment-html-").concat(t.cid,"').hidden=!0;gebi('view-html-").concat(t.cid,'\').hidden=!1;this.hidden=!0;" style="margin-left:3px" ').concat(t.can_edit?"hidden":"",">").concat(icon_with_text("markdown-primary","查看M↓"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm" id="view-html-').concat(t.cid,'" onclick="gebi(\'comment-md-').concat(t.cid,"').hidden=!0;gebi('comment-html-").concat(t.cid,"').hidden=!1;gebi('view-md-").concat(t.cid,'\').hidden=!1;this.hidden=!0;" style="margin-left:3px" hidden>').concat(icon_with_text("markdown-white","查看M↓"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline" id="edit-btn-').concat(t.cid,'" onclick="show_edit_window(').concat(t.cid,')" style="margin-left:3px" ').concat(t.can_edit?"":"hidden",">").concat(icon_with_text("edit-primary","编辑"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline" id="cancel-edit-btn-').concat(t.cid,'" onclick="hide_edit_window(').concat(t.cid,')" style="margin-left:3px" hidden>').concat(icon_with_text("x-primary","取消"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline" onclick="gebi(\'edit-preview-').concat(t.cid,"').innerHTML=marked.parse(gebi('edit-content-").concat(t.cid,"').value);gebi('edit-preview-").concat(t.cid,"').hidden=false;gebi('edit-div-").concat(t.cid,"').hidden=true;this.hidden=true;gebi('edit-").concat(t.cid,'-edit-btn\').hidden=false;" id="edit-').concat(t.cid,'-preview-btn" style="margin-left:3px" hidden>').concat(icon_with_text("eye-primary","预览"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline" onclick="gebi(\'edit-preview-').concat(t.cid,"').hidden=true;gebi('edit-div-").concat(t.cid,"').hidden=false;this.hidden=true;gebi('edit-").concat(t.cid,'-preview-btn\').hidden=false;" id="edit-').concat(t.cid,'-edit-btn" style="margin-left:3px" hidden>').concat(icon_with_text("edit-primary","编辑"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm" id="save-edit-btn-').concat(t.cid,'" onclick="save_edition(').concat(t.cid,')" style="margin-left:3px" hidden>').concat(icon_with_text("check-white","保存"),'</button><span id="edit-upload-btn-').concat(t.cid,'" hidden>').concat(pasteToUpload.gen_upload_btn("edit-content-"+t.cid,"sm")).concat(emotionBar.gen_open_btn("edit-content-"+t.cid,"sm"),'</span><span id="edit-result-').concat(t.cid,'" style="color:#aa0000;margin-left:3px"></span></div><div id="comment-window-').concat(t.cid,'" hidden><div id="content-').concat(t.cid,'-div"><textarea class="wux-form-input wux-form-input-md marked-textarea" placeholder="回复 #').concat(t.cid,' 最多1024字" rows="5" id="reply-content-').concat(t.cid,'" onchange="save_comment_draft(this,').concat(t.cid,');"></textarea></div><div id="content-preview-').concat(t.cid,'" class="pre-like" hidden></div><button class="wux-btn wux-btn-primary wux-btn-outline" onclick="gebi(\'comment-window-').concat(t.cid,"').hidden=!0;gebi('reply-btn-").concat(t.cid,'\').disabled=!1;" type="button" id="cancel-rp-').concat(t.cid,'">').concat(icon_with_text("x-primary","取消"),'</button><button class="wux-btn wux-btn-primary wux-btn-outline" onclick="gebi(\'content-preview-').concat(t.cid,"').innerHTML=marked.parse(gebi('reply-content-").concat(t.cid,"').value);gebi('content-preview-").concat(t.cid,"').hidden=false;gebi('content-").concat(t.cid,"-div').hidden=true;this.hidden=true;gebi('content-").concat(t.cid,'-edit-btn\').hidden=false;" type="button" id="content-').concat(t.cid,'-preview-btn" style="margin-left:3px">').concat(icon_with_text("eye-primary","预览"),'</button><button class="wux-btn wux-btn-primary wux-btn-outline" onclick="gebi(\'content-preview-').concat(t.cid,"').hidden=true;gebi('content-").concat(t.cid,"-div').hidden=false;this.hidden=true;gebi('content-").concat(t.cid,'-preview-btn\').hidden=false;" type="button" id="content-').concat(t.cid,'-edit-btn" style="margin-left:3px" hidden>').concat(icon_with_text("edit-primary","编辑"),'</button><button class="wux-btn wux-btn-primary" type="button" onclick="add_comment(').concat(t.cid,",gebi('reply-content-").concat(t.cid,'\').value)" id="rel-btn-').concat(t.cid,'" style="margin-left:3px">发表</button>').concat(pasteToUpload.gen_upload_btn("reply-content-"+t.cid,"md")).concat(emotionBar.gen_open_btn("reply-content-"+t.cid,"md"),'<span id="reply-result-').concat(t.cid,'" style="color:#aa0000;margin-left:3px"></span></div></div>'),t.replies)i+=read_comment(t.replies[n],e+1);return i}function ts2str(t){return(t=new Date(1e3*t)).getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)}function show_edit_window(t){gebi("edit-div-"+t).hidden=!1,gebi("comment-html-"+t).hidden=!0,gebi("save-edit-btn-"+t).hidden=!1,gebi("cancel-edit-btn-"+t).hidden=!1,gebi("edit-btn-"+t).hidden=!0,gebi("edit-".concat(t,"-preview-btn")).hidden=!1,gebi("edit-upload-btn-".concat(t)).hidden=!1}function hide_edit_window(t){gebi("edit-div-"+t).hidden=!0,gebi("comment-html-"+t).hidden=!1,gebi("save-edit-btn-"+t).hidden=!0,gebi("cancel-edit-btn-"+t).hidden=!0,gebi("edit-btn-"+t).hidden=!1,gebi("edit-".concat(t,"-preview-btn")).hidden=!0,gebi("edit-".concat(t,"-edit-btn")).hidden=!0,gebi("edit-preview-"+t).hidden=!0,gebi("edit-upload-btn-".concat(t)).hidden=!0}function save_edition(t){var e,n=gebi("edit-content-"+t).value;""!==n?n!==gebi("origin-content-"+t).value?(set_btn_html(gebi("save-edit-btn-"+t),"请稍候"),gebi("cancel-edit-btn-"+t).disabled=!0,gebi("edit-".concat(t,"-preview-btn")).disabled=!0,gebi("edit-".concat(t,"-edit-btn")).disabled=!0,(e=new XMLHttpRequest).open("POST",domain+"/api/edit_comment",!0),e.setRequestHeader("Content-Type","application/json"),e.send(JSON.stringify({access_token:localStorage["access-token"],cid:t,content:n})),e.onreadystatechange=function(){var n;4==e.readyState&&(set_btn_html(gebi("save-edit-btn-"+t)),gebi("cancel-edit-btn-"+t).disabled=!1,gebi("edit-".concat(t,"-preview-btn")).disabled=!1,gebi("edit-".concat(t,"-edit-btn")).disabled=!1,(n=JSON.parse(e.responseText)).success?(gebi("edit-result-"+t).innerHTML="保存成功!",get_all_comment()):gebi("edit-result-"+t).innerHTML=n.message)}):gebi("edit-result-"+t).innerHTML="你没有修改任何东西!":gebi("edit-result-"+t).innerHTML="编辑内容不能为空!"}function show_reply_window(t){null==localStorage["access-token"]?(localStorage.login_redirect=window.location.href,window.location="/login"):(gebi("reply-btn-"+t).disabled=!0,gebi("comment-window-"+t).hidden=!1,load_comment_draft(t))}function change_page(t){for(var e=document.getElementsByClassName("cp-btn"),n=0;n<e.length;n++)e[n].disabled=!0;comment_page_index=t,get_all_comment()}function show_image(t){t.src=t.getAttribute("src_"),t.hidden=!1}var comment_page_index=0,nurl=window.location.href.split("?"),place_id=114514;if(2===nurl.length){var args=nurl[1].split("&");place_id=args[0];is_in_array(args,"comments-only")&&function(){for(var t=document.getElementsByClassName("hco"),e=0;e<t.length;e++)t[e].hidden=!0}();for(var scroll_to=void 0,i=0;i<args.length;i++){var t=args[i].split("=");2===t.length&&"scroll_to"===t[0]&&(scroll_to=t[1])}}function load_comment_draft(t){function e(e){-1===t?gebi("result0").innerHTML=e:gebi("reply-result-".concat(t)).innerHTML=e}var n=localStorage.getItem("access-token");if(n){var i={place_id:place_id,reply_to:t,access_token:n};fetch_data(domain+"/api/get_comment_draft","POST",headers,JSON.stringify(i)).then((function(n){var i,o=JSON.parse(n.response_text);o.success?(i=o.data.content)&&(-1===t?gebi("content").value=i:gebi("reply-content-".concat(t)).value=i):e("无法加载草稿:"+o.message)}),(function(t){e("无法加载草稿:"+t.message)}))}}function save_comment_draft(t,e){function n(t){-1===e?gebi("result0").innerHTML=t:gebi("reply-result-".concat(e)).innerHTML=t}var i=(new Date).getTime()/1e3;if(!(i-last_save_draft<1)){last_save_draft=i;var o=localStorage.getItem("access-token");if(o){var c=t.value;if(c){var a={place_id:place_id,reply_to:e,content:c,access_token:o};fetch_data(domain+"/api/save_comment_draft","POST",headers,JSON.stringify(a)).then((function(t){var e=JSON.parse(t.response_text);e.success||n("无法保存草稿:"+e.message)}),(function(t){n("无法保存草稿:"+t.message)}))}}}}function get_notification_count(){return _get_notification_count.apply(this,arguments)}function _get_notification_count(){return(_get_notification_count=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,n,i;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=localStorage.getItem("access-token")){t.next=3;break}return t.abrupt("return");case 3:return t.next=5,fetch_data(domain+"/api/count_unread_notification","POST",headers,JSON.stringify({access_token:e})).catch((function(t){console.warn("failed to fetch notification count.")}));case 5:if((n=t.sent).response_text){t.next=8;break}return t.abrupt("return");case 8:(i=JSON.parse(n.response_text)).success?(gebi("notification-count").innerHTML=i.data.count.toString(),gebi("notification-count").hidden=0===i.data.count):console.warn(i.message);case 10:case"end":return t.stop()}}),t)})))).apply(this,arguments)}get_notification_count().then(),get_all_comment();