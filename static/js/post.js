"use strict";function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _regeneratorRuntime(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function(){return e};var t,e={},n=Object.prototype,i=n.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",r=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function d(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{d({},"")}catch(t){d=function(t,e,n){return t[e]=n}}function m(t,e,n,i){var a=e&&e.prototype instanceof _?e:_,c=Object.create(a.prototype),r=new N(i||[]);return o(c,"_invoke",{value:S(t,n,r)}),c}function l(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=m;var u="suspendedStart",p="suspendedYield",g="executing",b="completed",h={};function _(){}function v(){}function f(){}var w={};d(w,c,(function(){return this}));var y=Object.getPrototypeOf,x=y&&y(y(E([])));x&&x!==n&&i.call(x,c)&&(w=x);var k=f.prototype=_.prototype=Object.create(w);function L(t){["next","throw","return"].forEach((function(e){d(t,e,(function(t){return this._invoke(e,t)}))}))}function T(t,e){function n(o,a,c,r){var s=l(t[o],t,a);if("throw"!==s.type){var d=s.arg,m=d.value;return m&&"object"==_typeof(m)&&i.call(m,"__await")?e.resolve(m.__await).then((function(t){n("next",t,c,r)}),(function(t){n("throw",t,c,r)})):e.resolve(m).then((function(t){d.value=t,c(d)}),(function(t){return n("throw",t,c,r)}))}r(s.arg)}var a;o(this,"_invoke",{value:function(t,i){function o(){return new e((function(e,o){n(t,i,e,o)}))}return a=a?a.then(o,o):o()}})}function S(e,n,i){var o=u;return function(a,c){if(o===g)throw Error("Generator is already running");if(o===b){if("throw"===a)throw c;return{value:t,done:!0}}for(i.method=a,i.arg=c;;){var r=i.delegate;if(r){var s=M(r,i);if(s){if(s===h)continue;return s}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(o===u)throw o=b,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);o=g;var d=l(e,n,i);if("normal"===d.type){if(o=i.done?b:p,d.arg===h)continue;return{value:d.arg,done:i.done}}"throw"===d.type&&(o=b,i.method="throw",i.arg=d.arg)}}}function M(e,n){var i=n.method,o=e.iterator[i];if(o===t)return n.delegate=null,"throw"===i&&e.iterator.return&&(n.method="return",n.arg=t,M(e,n),"throw"===n.method)||"return"!==i&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+i+"' method")),h;var a=l(o,e.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,h;var c=a.arg;return c?c.done?(n[e.resultName]=c.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,h):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,h)}function H(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function O(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function N(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(H,this),this.reset(!0)}function E(e){if(e||""===e){var n=e[c];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,a=function n(){for(;++o<e.length;)if(i.call(e,o))return n.value=e[o],n.done=!1,n;return n.value=t,n.done=!0,n};return a.next=a}}throw new TypeError(_typeof(e)+" is not iterable")}return v.prototype=f,o(k,"constructor",{value:f,configurable:!0}),o(f,"constructor",{value:v,configurable:!0}),v.displayName=d(f,s,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===v||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,d(t,s,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},L(T.prototype),d(T.prototype,r,(function(){return this})),e.AsyncIterator=T,e.async=function(t,n,i,o,a){void 0===a&&(a=Promise);var c=new T(m(t,n,i,o),a);return e.isGeneratorFunction(n)?c:c.next().then((function(t){return t.done?t.value:c.next()}))},L(k),d(k,s,"Generator"),d(k,c,(function(){return this})),d(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var i in e)n.push(i);return n.reverse(),function t(){for(;n.length;){var i=n.pop();if(i in e)return t.value=i,t.done=!1,t}return t.done=!0,t}},e.values=E,N.prototype={constructor:N,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(O),!e)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function o(i,o){return r.type="throw",r.arg=e,n.next=i,o&&(n.method="next",n.arg=t),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var c=this.tryEntries[a],r=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var s=i.call(c,"catchLoc"),d=i.call(c,"finallyLoc");if(s&&d){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(s){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!d)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&i.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var c=a?a.completion:{};return c.type=t,c.arg=e,a?(this.method="next",this.next=a.finallyLoc,h):this.complete(c)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),h},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),O(n),h}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var i=n.completion;if("throw"===i.type){var o=i.arg;O(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,n,i){return this.delegate={iterator:E(e),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=t),h}},e}function asyncGeneratorStep(t,e,n,i,o,a,c){try{var r=t[a](c),s=r.value}catch(t){return void n(t)}r.done?e(s):Promise.resolve(s).then(i,o)}function _asyncToGenerator(t){return function(){var e=this,n=arguments;return new Promise((function(i,o){var a=t.apply(e,n);function c(t){asyncGeneratorStep(a,i,o,c,r,"next",t)}function r(t){asyncGeneratorStep(a,i,o,c,r,"throw",t)}c(void 0)}))}}var domain="https://comments.saobby.com",post_data={},comments_data={},args=get_url_args(),last_save_draft=0;function load_post(){if(args.pid){var t={name:args.pid};args.v&&(t.version=parseInt(args.v)),localStorage.getItem("access-token")&&(t.access_token=localStorage.getItem("access-token")),fetch_data(domain+"/api/get_post_details","POST",headers,JSON.stringify(t)).then((function(t){var e=JSON.parse(t.response_text);if(e.success){post_data=e.data,gebi("author").innerHTML=rsc(e.data.author),gebi("post-title").innerHTML=rsc(e.data.title),gebi("title-input").value=e.data.title,gebi("html").innerHTML=marked.parse(e.data.content),gebi("markdown").innerHTML=rsc(e.data.content),gebi("content-input").value=e.data.content,gebi("release-time").innerHTML=ts2str(e.data.modify_time),gebi("version").innerHTML=e.data.version.toString(),gebi("is-history").hidden=e.data.is_history,gebi("pinned").hidden=!e.data.is_pinned,gebi("status").innerHTML=e.data.is_closed?'<img src="/static/image/icon/lock-red.svg" width="36px" alt="[已关闭]" class="middle">':'<img src="/static/image/icon/circle-dot-green.svg" width="36px" alt="[开放]" class="middle">',gebi("status").setAttribute("style",e.data.is_closed?"color:#AA0000;":"color:#00AA00;"),gebi("loves").innerHTML=e.data.loves.toString(),gebi("views").innerHTML=e.data.views.toString(),gebi("delete-btn").hidden=!e.data.permissions.can_delete,gebi("close-btn").hidden=!e.data.permissions.can_close,gebi("open-btn").hidden=!e.data.permissions.can_open,gebi("pin-btn").hidden=!e.data.permissions.can_pin,gebi("unpin-btn").hidden=!e.data.permissions.can_unpin,gebi("edit-btn").hidden=!e.data.permissions.can_edit,gebi("add-tag-btn").hidden=!e.data.permissions.can_edit,gebi("view-markdown-btn").hidden=e.data.permissions.can_edit,gebi("loading-div").hidden=!0,gebi("post-view-div").hidden=!1,gebi("loved").innerHTML=e.data.loved?'<img src="/static/image/icon/thumb-up-filled-white.svg" width="16px" alt="已赞" class="middle">':'<img src="/static/image/icon/thumb-up-white.svg" width="16px" alt="点赞" class="middle">',gebi("love-btn").disabled=!1;var n="";for(var i in e.data.tags){var o=e.data.tags[i];n+='<span class="wux-tag simple">'.concat(rsc(o),'<span class="wux-tag-close post-tags-close-btn" onclick="remove_tag(').concat(i,');" ').concat(e.data.permissions.can_edit?"":"hidden",">×</span></span>")}gebi("tags-div").innerHTML=n||"无",comments_load(0,args.cid?parseInt(args.cid):null),load_comment_draft(-1)}else gebi("loading-result").innerHTML="无法加载帖子,因为:"+e.message,gebi("loading-div").hidden=!1,gebi("post-view-div").hidden=!0}),(function(t){gebi("loading-result").innerHTML="无法加载帖子,因为:"+t.message,gebi("loading-div").hidden=!1,gebi("post-view-div").hidden=!0}))}else gebi("loading-result").innerHTML="无法加载帖子,因为:参数错误"}function add_tag(){return _add_tag.apply(this,arguments)}function _add_tag(){return(_add_tag=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,n;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,prompt("添加标签","请输入希望添加的标签:",!0);case 2:if(null!==(e=t.sent)){t.next=6;break}return gebi("tag-result").innerHTML="操作被用户取消",t.abrupt("return");case 6:(n=post_data.tags.slice(0)).push(e),save_tags(n);case 9:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function remove_tag(t){var e=post_data.tags.slice(0);e.splice(t,1),save_tags(e)}function save_tags(t){function e(t){t?set_btn_html(gebi("add-tag-btn"),"..."):set_btn_html(gebi("add-tag-btn"));for(var e=gebcn("post-tags-close-btn"),n=0;n<e.length;n++)e[n].hidden=t}var n={access_token:localStorage["access-token"],name:args.pid,tags:t};e(!0),fetch_data(domain+"/api/set_post_tags","POST",headers,JSON.stringify(n)).then((function(t){var n=JSON.parse(t.response_text);n.success?(gebi("tag-result").innerHTML="设置成功",load_post()):gebi("tag-result").innerHTML=n.message,e(!1)}),(function(t){gebi("tag-result").innerHTML=t.message,e(!1)}))}function edit_post(t){gebi("edit-btn").hidden=t,gebi("cancel-edit-btn").hidden=!t,gebi("title-input").hidden=!t,gebi("post-title-h1").hidden=t,gebi("content-input").hidden=!t,gebi("html").hidden=t,gebi("preview-btn").hidden=!t,gebi("close-preview-btn").hidden=!0,gebi("preview-html").hidden=!0,gebi("save-edit-btn").hidden=!t,gebi("edit-upload-btn-span").hidden=!t,gebi("edit-emotions-btn-span").hidden=!t}function preview(t){gebi("preview-btn").hidden=t,gebi("close-preview-btn").hidden=!t,gebi("preview-html").innerHTML=marked.parse(gebi("content-input").value),gebi("preview-html").hidden=!t,gebi("content-input").hidden=t}function save_edit(){return _save_edit.apply(this,arguments)}function _save_edit(){return(_save_edit=_asyncToGenerator(_regeneratorRuntime().mark((function t(){var e,n,i;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=gebi("title-input").value,n=gebi("content-input").value,""!==e&&""!==n){t.next=5;break}return gebi("operate-result").innerHTML="标题和正文均不能为空",t.abrupt("return");case 5:if(n!==post_data.content||e!==post_data.title){t.next=8;break}return gebi("operate-result").innerHTML="你没有修改任何东西",t.abrupt("return");case 8:return t.next=10,prompt("保存编辑","请填写编辑摘要/原因:",!0);case 10:if(null!==(i=t.sent)){t.next=14;break}return gebi("operate-result").innerHTML="用户取消了保存",t.abrupt("return");case 14:gebi("content-input").disabled=!0,gebi("title-input").disabled=!0,set_btn_html(gebi("save-edit-btn"),"..."),saobbyCaptchaV2.open_window_and_return_promise().then((function(t){set_btn_html(gebi("save-edit-btn"),"请稍候");var o={access_token:localStorage.getItem("access-token"),name:args.pid,title:e,content:n,description:i,captcha_token:gebi("scpc-token").value};fetch_data(domain+"/api/edit_post","POST",headers,JSON.stringify(o)).then((function(t){var e=JSON.parse(t.response_text);e.success?(gebi("operate-result").innerHTML="编辑成功",args.v?window.location="/post/?pid="+args.pid:(edit_post(!1),load_post())):gebi("operate-result").innerHTML=e.message,gebi("content-input").disabled=!1,gebi("title-input").disabled=!1,set_btn_html(gebi("save-edit-btn"))}),(function(t){gebi("operate-result").innerHTML=t.message,gebi("content-input").disabled=!1,gebi("title-input").disabled=!1,set_btn_html(gebi("save-edit-btn"))}))}),(function(t){gebi("operate-result").innerHTML="请先完成人机验证:"+t.message,gebi("content-input").disabled=!1,gebi("title-input").disabled=!1,set_btn_html(gebi("save-edit-btn"))}));case 18:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function view_markdown(t){gebi("view-markdown-btn").hidden=t,gebi("view-markdown-btn-pressed").hidden=!t,gebi("markdown").hidden=!t,gebi("html").hidden=t}function love(){if(!check_logged_in()){gebi("loved").innerHTML="请稍候",gebi("love-btn").disabled=!0;var t={access_token:localStorage.getItem("access-token"),name:args.pid,value:!post_data.loved};fetch_data(domain+"/api/love_post","POST",headers,JSON.stringify(t)).then((function(t){var e=JSON.parse(t.response_text);e.success?load_post():(gebi("operate-result").innerHTML=e.message,gebi("love-btn").disabled=!1,gebi("loved").innerHTML=post_data.loved?'<img src="/static/image/icon/thumb-up-filled-white.svg" width="16px" alt="已赞" class="middle">':'<img src="/static/image/icon/thumb-up-white.svg" width="16px" alt="点赞" class="middle">')}),(function(t){gebi("operate-result").innerHTML=t.message,gebi("love-btn").disabled=!1,gebi("loved").innerHTML=post_data.loved?'<img src="/static/image/icon/thumb-up-filled-white.svg" width="16px" alt="已赞" class="middle">':'<img src="/static/image/icon/thumb-up-white.svg" width="16px" alt="点赞" class="middle">'}))}}function operate(t){return _operate.apply(this,arguments)}function _operate(){return(_operate=_asyncToGenerator(_regeneratorRuntime().mark((function t(e){var n,i;return _regeneratorRuntime().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("close"!==e){t.next=7;break}return t.next=3,confirm("警告!","你确定要关闭这个帖子吗?关闭后你将无法再打开!");case 3:if(t.sent){t.next=7;break}return gebi("operate-result").innerHTML="操作被用户取消",t.abrupt("return");case 7:n=e+"-btn",gebi(n).innerHTML,set_btn_html(gebi(n),"请稍候"),i={access_token:localStorage.getItem("access-token"),name:args.pid,action:e},fetch_data(domain+"/api/operate_post","POST",headers,JSON.stringify(i)).then((function(t){var i=JSON.parse(t.response_text);i.success?(gebi("operate-result").innerHTML="操作成功","delete"===e?window.location="/posts":load_post()):gebi("operate-result").innerHTML=i.message,set_btn_html(gebi(n))}),(function(t){gebi("operate-result").innerHTML=t.message,set_btn_html(gebi(n))}));case 12:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function show_history(){set_btn_html(gebi("view-history-btn"),"..."),gebi("history-div").hidden=!1,gebi("history-content-div").innerHTML="正在加载编辑记录...",load_history(0)}function close_history(){set_btn_html(gebi("view-history-btn")),gebi("history-div").hidden=!0}function load_history(t){for(var e={name:args.pid,page_index:t,page_size:3},n=gebcn("history-cp-btn"),i=0;i<n.length;i++)n[i].disabled=!0;fetch_data(domain+"/api/get_edit_history","POST",headers,JSON.stringify(e)).then((function(t){var e=JSON.parse(t.response_text);if(e.success){var i="";for(var o in e.data.history){var a=e.data.history[o];i+="<b>".concat(icon_with_text("versions","V"+a.version.toString()),'</b><span style="color:#777;"> ').concat(icon_with_text("clock-grey",ts2str(a.timestamp)),"</span><br><span ").concat(a.description?"":"hidden",">").concat(icon_with_text("file-description",rsc(a.description)),'</span><a href="/post/?pid=').concat(args.pid,"&v=").concat(a.version,'" target="_blank" ').concat(post_data.version===a.version?"hidden":"",'><button class="wux-btn wux-btn-primary wux-btn-xs" style="margin-left:10px" type="button">').concat(icon_with_text("eye-white","查看此版本"),'</button></a><i style="color:#777;" ').concat(post_data.version===a.version?"":"hidden","> (当前版本)</i><hr>")}gebi("history-content-div").innerHTML=i,gebi("history-page-index").innerHTML=(e.data.page_index+1).toString(),gebi("history-page-amount").innerHTML=e.data.page_amount.toString(),gen_cp_buttons(e.data.page_index+1,e.data.page_amount,7,(function(t){load_history(t-1)}),gebi("history-change-page-btn"),"wux-btn history-cp-btn","wux-btn wux-btn-outline history-cp-btn")}else gebi("history-content-div").innerHTML="无法加载编辑记录,因为:"+e.message;for(var c=0;c<n.length;c++)n[c].disabled=!1}),(function(t){gebi("history-content-div").innerHTML="无法加载编辑记录,因为:"+t.message;for(var e=0;e<n.length;e++)n[e].disabled=!1}))}function comments_preview(t,e){t=t.toString();gebi("comments-preview-"+t).innerHTML=marked.parse(gebi("comments-content-"+t).value),gebi("comments-content-"+t).hidden=e,gebi("comments-preview-"+t).hidden=!e,gebi("comments-preview-btn-"+t).hidden=e,gebi("comments-edit-btn-"+t).hidden=!e}function comments_release(t){function e(e){gebi("comments-content-"+t).disabled=e,gebi("comments-cancel-btn-"+t).disabled=e}t=t.toString();var n=gebi("comments-content-"+t).value;""!==n?(e(!0),set_btn_html(gebi("comments-release-btn-"+t),"..."),saobbyCaptchaV2.open_window_and_return_promise().then((function(i){set_btn_html(gebi("comments-release-btn-"+t),"请稍候"),fetch_data(domain+"/api/post_comment","POST",headers,JSON.stringify({place_id:post_data.comment_place_id,access_token:localStorage["access-token"],content:n,reply_to:parseInt(t),captcha_token:gebi("scpc-token").value})).then((function(n){var i=JSON.parse(n.response_text);i.success?(gebi("comments-result-"+t).innerHTML="发送成功",gebi("comments-content-"+t).value="",gebi("comments-preview-"+t).innerHTML="",comments_load("-1"===t?0:comments_data.common.page_index,null)):gebi("comments-result-"+t).innerHTML=i.message,e(!1),set_btn_html(gebi("comments-release-btn-"+t))}),(function(n){gebi("comments-result-"+t).innerHTML=n.message,e(!1),set_btn_html(gebi("comments-release-btn-"+t))}))}),(function(n){gebi("comments-result-"+t).innerHTML="请先完成验证码:"+n.message,e(!1),set_btn_html(gebi("comments-release-btn-"+t))}))):gebi("comments-result-"+t).innerHTML="评论内容不能为空"}function comments_load(t,e){function n(t,e){var i="";for(var o in t){var a=t[o];i+='<div style="position:relative;left:'.concat(20*e,'px;" id="comment-div-').concat(a.cid,'"><div style="border-bottom: 2px solid #ddd;padding:12px 16px;"><img src="').concat(a.avatar_url,'" alt="用户头像" width="32px" height="32px"><b style="position:relative;top:-17px;left:5px;">').concat(a.nickname?rsc(a.nickname):rsc(a.username),'</b><span style="color:#777777;position:relative;top:-17px;left:5px;" class="middle"> <img src="/static/image/icon/mail-check-grey.svg" width="16px" alt="(已绑定电子邮箱)" title="此用户已绑定电子邮箱" class="middle" ').concat(a.is_email_checked?"":"hidden","> ").concat(a.modify_time?'<img src="/static/image/icon/pencil-check-grey.svg" width="16px" alt="(已编辑)" title="(已编辑)" class="middle"> <img src="/static/image/icon/clock-grey.svg" width="16px" alt="编辑时间" class="middle">':'<img src="/static/image/icon/clock-grey.svg" width="16px" alt="发表时间" class="middle">').concat(a.modify_time?ts2str(a.modify_time):ts2str(a.timestamp)," #").concat(a.cid,'</span><br><span style="color:#777777" class="middle" onclick="window.scrollTo(get_element_abs_pos2(gebi(\'comment-div-').concat(a.reply_to,"')))\" ").concat(-1===a.reply_to?"hidden":"",'><img src="/static/image/icon/corner-down-right-grey.svg" alt="" width="16px" class="middle">回复 #').concat(a.reply_to,"</span><br ").concat(-1===a.reply_to?"hidden":"",'><div id="comment-markdown-').concat(a.cid,'" class="pre-like-code" hidden>').concat(rsc(a.content),'</div><textarea id="comment-origin-content-').concat(a.cid,'" hidden>').concat(rsc(a.content),'</textarea><textarea class="wux-form-input wux-form-input-md marked-textarea" placeholder="编辑 #').concat(a.cid,' 最多1024字" rows="5" id="comment-edit-content-').concat(a.cid,'" hidden>').concat(rsc(a.content),'</textarea><div id="comment-edit-preview-').concat(a.cid,'" class="pre-like"  hidden></div><div class="comment-content" id="comment-html-').concat(a.cid,'">').concat(marked.parse(a.content),'</div><i style="color:#777777;" ').concat(null===a.is_read?"hidden":"",">").concat(null!==a.is_read?a.is_read?"已读("+ts2str(a.read_time)+")":"未读":"","</i><br ").concat(null===a.is_read?"hidden":"",'><button type="button" class="wux-btn wux-btn-primary wux-btn-sm" id="comment-reply-btn-').concat(a.cid,'" onclick="comments_reply_window(').concat(a.cid,',true);">').concat(icon_with_text("message-reply-white","回复"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline simple" id="comment-view-md-btn-').concat(a.cid,'" onclick="comments_markdown(').concat(a.cid,',true);" ').concat(a.can_edit?"hidden":"",">").concat(icon_with_text("markdown-primary","查看M↓"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm simple" id="comment-view-html-btn-').concat(a.cid,'" onclick="comments_markdown(').concat(a.cid,',false);" hidden>').concat(icon_with_text("markdown-white","查看M↓"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline simple" id="comment-edit-btn-').concat(a.cid,'" onclick="comments_edit(').concat(a.cid,',true);" ').concat(a.can_edit?"":"hidden",">").concat(icon_with_text("edit-primary","编辑"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline simple" id="comment-cancel-edit-btn-').concat(a.cid,'" onclick="comments_edit(').concat(a.cid,',false);" hidden>').concat(icon_with_text("x-primary","取消"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline simple" onclick="comments_edit_preview(').concat(a.cid,',true);" id="comment-preview-btn-').concat(a.cid,'" hidden>').concat(icon_with_text("eye-primary","预览"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm wux-btn-outline simple" onclick="comments_edit_preview(').concat(a.cid,',false);" id="comment-close-preview-btn-').concat(a.cid,'" hidden>').concat(icon_with_text("edit-primary","编辑"),'</button><button type="button" class="wux-btn wux-btn-primary wux-btn-sm simple" id="comment-save-edit-btn-').concat(a.cid,'" onclick="comments_save_edit(').concat(a.cid,');" hidden>').concat(icon_with_text("check-white","保存"),'</button><span id="edit-comment-upload-btn-span-').concat(a.cid,'" hidden>').concat(pasteToUpload.gen_upload_btn("comment-edit-content-"+a.cid,"sm")).concat(emotionBar.gen_open_btn("comment-edit-content-"+a.cid,"sm"),'</span><span id="comment-edit-result-').concat(a.cid,'" class="result simple"></span></div><div id="comment-reply-div-').concat(a.cid,'" hidden><textarea class="wux-form-input wux-form-input-md marked-textarea" placeholder="回复 #').concat(a.cid,' 最多1024字" rows="5" id="comments-content-').concat(a.cid,'" onchange="save_comment_draft(this,').concat(a.cid,');"></textarea><div id="comments-preview-').concat(a.cid,'" class="pre-like" hidden></div><button class="wux-btn wux-btn-primary wux-btn-outline" onclick="comments_reply_window(').concat(a.cid,',false);" type="button" id="comments-cancel-btn-').concat(a.cid,'">').concat(icon_with_text("x-primary","取消"),'</button><button class="wux-btn wux-btn-primary wux-btn-outline simple" onclick="comments_preview(').concat(a.cid,',true);" type="button" id="comments-preview-btn-').concat(a.cid,'">').concat(icon_with_text("eye-primary","预览"),'</button><button class="wux-btn wux-btn-primary wux-btn-outline simple" onclick="comments_preview(').concat(a.cid,',false);" type="button" id="comments-edit-btn-').concat(a.cid,'" hidden>').concat(icon_with_text("edit-primary","编辑"),'</button><button class="wux-btn wux-btn-primary simple" type="button" onclick="comments_release(').concat(a.cid,');" id="comments-release-btn-').concat(a.cid,'">发表</button><span id="release-comment-upload-btn-span-').concat(a.cid,'">').concat(pasteToUpload.gen_upload_btn("comments-content-"+a.cid,"md")).concat(emotionBar.gen_open_btn("comments-content-"+a.cid,"md"),'</span><span id="comments-result-').concat(a.cid,'" class="result simple"></span></div></div>'),i+=n(a.replies,e+1)}return i}var i={place_id:post_data.comment_place_id,amount_per_page:8,page_index:t};null!==e&&(i.scroll_to=e),localStorage.getItem("access-token")&&(i.access_token=localStorage["access-token"]);for(var o=gebcn("comments-cp-btn"),a=0;a<o.length;a++)o[a].disabled=!0;fetch_data(domain+"/api/get_comment","POST",headers,JSON.stringify(i)).then((function(t){var i=JSON.parse(t.response_text);if(i.success){comments_data.common={page_index:i.comment_data.page_index-1,page_amount:i.comment_data.page_amount},comments_data.comments=i.data;var a=n(i.data,0);gebi("comments-view-div").innerHTML=a||'<span style="color:#777;">还没有评论</span>',gebi("comments-page-index").innerHTML=i.comment_data.page_index.toString(),gebi("comments-page-amount").innerHTML=i.comment_data.page_amount.toString(),gen_cp_buttons(i.comment_data.page_index,i.comment_data.page_amount,7,(function(t){comments_load(t-1,null)}),gebi("comments-change-page-div"),"wux-btn comments-cp-btn","wux-btn wux-btn-outline comments-cp-btn"),pasteToUpload.init(),add_markdown_tips(),e&&window.scrollTo(get_element_abs_pos2(gebi("comment-div-".concat(e))))}else gebi("comments-view-div").innerHTML="无法获取到评论,因为:"+i.message;for(var c=0;c<o.length;c++)o[c].disabled=!1}),(function(t){gebi("comments-view-div").innerHTML="无法获取到评论,因为:"+t.message;for(var e=0;e<o.length;e++)o[e].disabled=!1}))}function comments_save_edit(t){function e(e){gebi("comment-cancel-edit-btn-".concat(t)).disabled=e,gebi("comment-edit-content-".concat(t)).disabled=e}var n=gebi("comment-edit-content-".concat(t)).value;if(""!==n)if(n!==gebi("comment-origin-content-".concat(t)).value){e(!0),set_btn_html(gebi("comment-save-edit-btn-".concat(t)),"请稍候");var i={access_token:localStorage["access-token"],cid:t,content:n};fetch_data(domain+"/api/edit_comment","POST",headers,JSON.stringify(i)).then((function(n){var i=JSON.parse(n.response_text);i.success?(gebi("comment-edit-result-".concat(t)).innerHTML="编辑成功",comments_load(comments_data.common.page_index,null)):gebi("comment-edit-result-".concat(t)).innerHTML=i.message,e(!1),set_btn_html(gebi("comment-save-edit-btn-".concat(t)))}),(function(n){gebi("comment-edit-result-".concat(t)).innerHTML=n.message,e(!1),set_btn_html(gebi("comment-save-edit-btn-".concat(t)))}))}else gebi("comment-edit-result-".concat(t)).innerHTML="你没有修改任何东西";else gebi("comment-edit-result-".concat(t)).innerHTML="评论内容不能为空"}function comments_reply_window(t,e){check_logged_in()||(gebi("comment-reply-btn-".concat(t)).disabled=e,gebi("comment-reply-div-".concat(t)).hidden=!e,load_comment_draft(t))}function comments_edit(t,e){gebi("comment-edit-btn-".concat(t)).hidden=e,gebi("comment-cancel-edit-btn-".concat(t)).hidden=!e,gebi("comment-edit-content-".concat(t)).hidden=!e,gebi("comment-edit-preview-".concat(t)).hidden=!0,gebi("comment-html-".concat(t)).hidden=e,gebi("comment-preview-btn-".concat(t)).hidden=!e,gebi("comment-close-preview-btn-".concat(t)).hidden=!0,gebi("comment-save-edit-btn-".concat(t)).hidden=!e,gebi("edit-comment-upload-btn-span-".concat(t)).hidden=!e}function comments_edit_preview(t,e){t=t.toString();gebi("comment-edit-preview-"+t).innerHTML=marked.parse(gebi("comment-edit-content-"+t).value),gebi("comment-edit-content-"+t).hidden=e,gebi("comment-edit-preview-"+t).hidden=!e,gebi("comment-preview-btn-"+t).hidden=e,gebi("comment-close-preview-btn-"+t).hidden=!e}function comments_markdown(t,e){gebi("comment-view-md-btn-".concat(t)).hidden=e,gebi("comment-view-html-btn-".concat(t)).hidden=!e,gebi("comment-markdown-".concat(t)).hidden=!e,gebi("comment-html-".concat(t)).hidden=e}function load_comment_draft(t){function e(e){gebi("comments-result-".concat(t)).innerHTML=e}var n=localStorage.getItem("access-token");if(n){var i={place_id:post_data.comment_place_id,reply_to:t,access_token:n};fetch_data(domain+"/api/get_comment_draft","POST",headers,JSON.stringify(i)).then((function(n){var i,o=JSON.parse(n.response_text);o.success?(i=o.data.content)&&(gebi("comments-content-".concat(t)).value=i):e("无法加载草稿:"+o.message)}),(function(t){e("无法加载草稿:"+t.message)}))}}function save_comment_draft(t,e){function n(t){gebi("comments-result-".concat(e)).innerHTML=t}var i=(new Date).getTime()/1e3;if(!(i-last_save_draft<1)){last_save_draft=i;var o=localStorage.getItem("access-token");if(o){var a=t.value;if(a){var c={place_id:post_data.comment_place_id,reply_to:e,content:a,access_token:o};fetch_data(domain+"/api/save_comment_draft","POST",headers,JSON.stringify(c)).then((function(t){var e=JSON.parse(t.response_text);e.success||n("无法保存草稿:"+e.message)}),(function(t){n("无法保存草稿:"+t.message)}))}}}}load_post(),function(){var t=null===localStorage.getItem("access-token");gebi("comments-release-btn--1").disabled=t,gebi("comments-login-btn").hidden=!t}();